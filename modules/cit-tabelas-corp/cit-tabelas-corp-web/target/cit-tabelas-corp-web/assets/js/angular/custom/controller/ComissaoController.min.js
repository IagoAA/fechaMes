citApp.controller("ComissaoController",["$scope","$window","ComissaoRepository","PessoaRepository","$translate","$timeout","$filter","$injector","DominioRepository",function(a,e,d,l,c,f,m,h,n){a.colaboradorIntegrante=null;a.resetForm=function(){a.limparComissao();a.edit=!0;a.pgEdit=!0;a.emUso=!1;f(function(){a.comissaoForm.$submitted=!1;a.comissaoForm.$setPristine();a.comissaoForm["observacao.descricao"]&&(a.comissaoForm["observacao.descricao"].$setViewValue(""),a.comissaoForm["observacao.descricao"].$render())})};
a.limparComissao=function(){a.comissao={observacoes:[],dataFormacao:m("date")(new Date,"dd/MM/yyyy")}};a.saveOrUpdate=function(){a.comissaoForm.$submitted=!0;a.setLoadingSalva(!0);if(a.comissaoForm.$valid)if(a.comissao.organizacao=a.usuarioLogado.organizacao,a.comissao.dataFormacao&&p(converterStringEmDate(a.comissao.dataFormacao)))if(a.comissao.dataExtincao&&!q(converterStringEmDate(a.comissao.dataExtincao),converterStringEmDate(a.comissao.dataFormacao)))a.showAlert("error",c.instant("MSG.DATA_EXTINCAO_MENOR_FORMACAO")),
a.setLoading(!1);else if(""==a.comissao.dataExtincao&&(a.comissao.dataExtincao=null),null==a.comissao.presidente)a.setLoading(!1),a.showAlert("error",c.instant("VALIDACAO.PRESIDENTE_NAO_INFORMADO"));else{var b=a.comissao.integrantes;void 0===b||null===b||3>b.length?(a.setLoading(!1),a.showAlert("error",c.instant("VALIDACAO.MINIMO_INTEGRANTES"))):d.save(a.comissao).then(function(b){a.comissao=b.originalElement;a.setLoading(!1);a.showAlert("success",c.instant("MSG.MG001"));a.comissaoForm.$submitted=
!1})}else a.showAlert("error",c.instant("MSG.DATA_FORMACAO_MAIOR_ATUAL")),a.setLoading(!1);else a.setLoading(!1),a.showAlert("error",c.instant("VALIDACAO.ALERTA_OBRIGATORIOS"))};a.getComissao=function(b,k){a.setLoadingGet(!0);a.emUso=!1;var c=b.id;d.get(c).then(function(b){a.organizacao=a.usuarioLogado.organizacao;a.comissao=b.originalElement;a.edit=k;a.setLoading(!1);a.selectedAll=!1});a.isModuloAtivo("/citgrp-patrimonio-web")&&h.get(["InventarioRepository"]).existeVinculo({joinClass:"inventarioComissao.id",
id:c}).then(function(b){f(function(){b&&(a.emUso=!0);h.get(["BaixaRepository"]).existeVinculo({joinClass:"desfazimentoComissao.id",id:c}).then(function(b){f(function(){b&&(a.emUso=!0)})})})});a.pgEdit=k};a.findIntegranteComissao=function(b){return l.findColaboradorPorNome(b).then(function(b){if(null!=a.comissao.integrantes&&0<a.comissao.integrantes.length)for(var c=a.comissao.integrantes.length,d=b.length,f=0;f<c;f++)for(var e=a.comissao.integrantes[f].integrante,g=0;g<d;g++)b[g].id==e.id&&(b.splice(g,
1),g=d=b.length);return b})};a.setIntegranteComissao=function(b){a.colaboradorIntegrante=b};a.limparIntegranteComissao=function(){delete a.colaboradorIntegrante};a.addIntegranteComissao=function(){if(void 0==a.colaboradorIntegrante||""==a.colaboradorIntegrante||null==a.colaboradorIntegrante)a.showAlert("error",c.instant("MSG.SELECIONE_COLABORADOR"));else if(void 0==a.colaboradorIntegrante.id||""==a.colaboradorIntegrante.id||null==a.colaboradorIntegrante.id)a.showAlert("error",c.instant("MSG.SELECIONE_COLABORADOR"));
else{null==a.comissao.integrantes&&(a.comissao.integrantes=[]);if(a.isPresidente){if(null!=a.comissao.presidente){a.showAlert("error",c.instant("MSG.PRESIDENTE_JA_INFORMADO"));return}a.comissao.presidente=a.colaboradorIntegrante}a.comissao.integrantes.push({integrante:a.colaboradorIntegrante});delete a.colaboradorIntegrante;delete a.isPresidente}};a.remove=function(b){a.$openModalConfirm({message:c.instant("MSG.CONFIRMA_EXCLUSAO"),callback:function(){a.setLoadingSalva(!0);void 0!==b.id&&d.remove(b).then(function(){a.comissao=
{};a.$modalConfirmInstance.dismiss("cancel");a.setLoading(!1);a.showAlert("success",c.instant("MSG.REGISTRO_EXCLUIDO"));angular.element("#searchComissao").scope().fetchResult();a.resetForm()})}})};a.atualizaPaginaPesquisa=function(){angular.element("#searchComissao").scope().fetchResult()};a.checkAll=function(b){angular.forEach(a.comissao.integrantes,function(a,c){a.$selected=b;a.$index=c})};a.verificaSelectedAll=function(b){var c=!0;b.$selected?(angular.forEach(a.comissao.integrantes,function(a){a.$selected||
(c=!1)}),c&&(a.selectedAll=!0)):a.selectedAll=!1};a.prepararExcluirItensSelecionados=function(){var b=r();0<b.length?a.$openModalConfirm({message:c.instant("MSG.DESEJA_EXCLUIR_ITENS"),callback:function(){angular.forEach(b,function(b,c){null!=a.comissao.presidente&&a.comissao.presidente.id==b.integrante.id&&(a.comissao.presidente=null);angular.forEach(a.comissao.integrantes,function(c,d){c.integrante.id==b.integrante.id&&(void 0!==c.id&&comissaoIntegranteRepository.remove(c),a.comissao.integrantes.splice(d,
1))})});a.$modalConfirmInstance.dismiss("cancel")}}):a.showAlert("warning",c.instant("MSG.SELECIONE_UM_ITEM_PARA_SER_REMOVIDO"))};var r=function(){var b=[];angular.forEach(a.comissao.integrantes,function(a){a.$selected&&b.push(a)});return b},p=function(a){a.setHours(0,0,0,0);var c=new Date;c.setHours(0,0,0,0);return a.getTime()>c.getTime()?!1:!0},q=function(a,c){a.setHours(0,0,0,0);c.setHours(0,0,0,0);return c.getTime()>=a.getTime()?!1:!0};(function(){n.findAllDominio("tipoComissao").then(function(b){a.dominiosTipoComissao=
b})})()}]);citApp.filter("orderIntegrantesBy",[function(){return function(a){if(!angular.isObject(a))return a;var e=[],d;for(d in a)"fill"!=d&&e.push(a[d]);e.sort(function(a,c){var d=a.integrante.pessoa.nome.toLowerCase(),e=c.integrante.pessoa.nome.toLowerCase();return d>e?1:d<e?-1:0});return e}}]);