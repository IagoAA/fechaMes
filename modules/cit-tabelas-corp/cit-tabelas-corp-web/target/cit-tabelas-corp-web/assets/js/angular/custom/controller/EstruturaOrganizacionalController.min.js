citApp.controller("EstruturaOrganizacionalController",["$scope","$filter","$translate","EstruturaOrganizacionalRepository","DominioRepository","EstruturaOrganizacionalResponsavelRepository","LocalizacaoRepository","PessoaRepository","FuncaoRepository","$timeout","$injector",function(a,h,c,g,n,p,q,r,u,m,f){function s(){a.$openModalConfirm({message:c.instant("MSG.CONFIRMA_DATA_FIM"),callback:function(){k();a.$modalConfirmInstance.dismiss("cancel")}})}function k(){a.setLoadingSalva(!0);g.save(a.estruturaOrganizacional).then(function(b){a.estruturaOrganizacional=
b.originalElement;a.patrimonioAtivo&&(a.estruturaOrganizacionalPatrimonio.estruturaOrganizacional||(a.estruturaOrganizacionalPatrimonio.isAlmoxarifado=!1,a.estruturaOrganizacionalPatrimonio.isLocalizadoraDeBem=!1,a.estruturaOrganizacionalPatrimonio.estruturaOrganizacional=a.estruturaOrganizacional),b=f.get(["EstruturaOrganizacionalPatrimonioRepository"]),b.save(a.estruturaOrganizacionalPatrimonio).then(function(b){a.estruturaOrganizacionalPatrimonio=b.originalElement}));a.almoxarifadoAtivo&&(a.estruturaOrganizacionalAlmoxarifado.estruturaOrganizacional||
(a.estruturaOrganizacionalAlmoxarifado.isAlmoxarifado=!1,a.estruturaOrganizacionalAlmoxarifado.isUnidadeConsumidoraRequisitante=!1,a.estruturaOrganizacionalAlmoxarifado.estruturaOrganizacional=a.estruturaOrganizacional),b=f.get(["EstruturaOrganizacionalAlmoxarifadoRepository"]),b.save(a.estruturaOrganizacionalAlmoxarifado).then(function(b){a.estruturaOrganizacionalAlmoxarifado=b.originalElement}));a.showAlert("success",c.instant("MSG.MG001"));a.estruturaOrganizacionalForm.$submitted=!1;a.setLoading(!1)})}
function l(){a.diasRequisitados=[];var b={key:"",value:""};if(void 0!==a.estruturaOrganizacionalAlmoxarifado.isUnidadeConsumidoraRequisitante&&a.estruturaOrganizacionalAlmoxarifado.isUnidadeConsumidoraRequisitante&&void 0!==a.estruturaOrganizacionalAlmoxarifado.diasQueUnidadeConsumidoraPodeFazerRequisicao&&null!==a.estruturaOrganizacionalAlmoxarifado.diasQueUnidadeConsumidoraPodeFazerRequisicao&&0<a.estruturaOrganizacionalAlmoxarifado.diasQueUnidadeConsumidoraPodeFazerRequisicao.length){var d=a.estruturaOrganizacionalAlmoxarifado.diasQueUnidadeConsumidoraPodeFazerRequisicao.split(";");
a.diasRequisitados=[];a.diasCompletos=[];for(var e=0;e<d.length-1;e++)a.diasRequisitados.push(d[e]);for(e=1;31>=e;e++)b.key=e,b.value=!1,angular.forEach(a.diasRequisitados,function(a){(new Number(a)).valueOf()===e&&(b.value=!0)}),a.diasCompletos.push(angular.copy(b))}else for(a.diasCompletos=[],e=1;31>=e;e++)b.key=e,b.value=!1,a.diasCompletos.push(angular.copy(b))}function t(){var b="";angular.forEach(a.diasCompletos,function(a){a.value&&(b+=a.key.toString().concat(";"))});return""===b?null:b}a.estruturaOrganizacional=
{estruturasOrganizacionalResponsaveis:[]};a.estruturaOrganizacionalPatrimonio={};a.estruturaOrganizacionalAlmoxarifado={};a.edit=!0;a.resetForm=function(b){a.estruturaOrganizacional={estruturasOrganizacionalResponsaveis:[]};b&&(a.estruturaOrganizacional.estruturaOrganizacionalParent=b);a.estruturaOrganizacionalPatrimonio={};a.estruturaOrganizacionalAlmoxarifado={};a.edit=!0;m(function(){a.estruturaOrganizacionalForm.$submitted=!1;a.estruturaOrganizacionalForm.$setPristine()})};a.atualizaPaginaPesquisa=
function(){angular.element("#searchEstruturaOrganizacional").scope().fetchResultEstrutura()};n.findAllDominio("tipoEstruturaOrganizacional").then(function(b){a.dominiosTipoEstruturaOrganizacional=b});a.findEstruturaSuperior=function(b){return g.listarEstruturasOrganizacionaisPorOrganizacao(b,a.usuarioLogado.organizacao.id).then(function(b){return h("idNotObject")(b,a.estruturaOrganizacional)})};a.limparEstruturaOrganizacionalParent=function(){delete a.estruturaOrganizacional.estruturaOrganizacionalParent};
a.removeCheckedResponsavel=function(){a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis.forEach(function(a){a.$checked=!1})};a.getCheckedResponsavel=function(){var b=null;a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis.forEach(function(a){a.$checked&&(b=a)});return b};a.checkResponsavel=function(b,d){a.removeCheckedResponsavel();b.$checked=!0;b.$index=d};a.removeEstruturaOrganizacionalResponsavel=function(){var b=a.getCheckedResponsavel();b?a.$openModalConfirm({message:c.instant("MSG.MG004"),
callback:function(){a.setLoading(!0);void 0!==b.id?p.remove(b).then(function(){a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis.splice(b.$index,1)}):a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis.splice(b.$index,1);a.showAlert("success",c.instant("MSG.EXCLUSAO_SUCESSO"));a.setLoading(!1);a.$modalConfirmInstance.dismiss("cancel")}}):a.showAlert("warning",c.instant("MSG.SELECIONE_UM_ITEM_PARA_SER_REMOVIDO"))};a.findLocalizacao=function(b){return q.listarLocalizacaoPorOrganizacao(b,
a.usuarioLogado.organizacao.id).then(function(a){return a})};a.setLocalizacao=function(b){a.estruturaOrganizacional.localizacao=b};a.limparLocalizacao=function(){delete a.estruturaOrganizacional.localizacao};a.abrirNovoColaborador=function(){a.openWorkspaceIfNotOpen(c.instant("LABEL.PESSOA"),"/cit-tabelas-corp-web/html/pessoa/pessoa.html","mod-blue");m(function(){angular.element("#searchPessoa").scope().$showPageEditWorkspace(angular.element("#searchPessoa").scope().workspace);angular.element("#pessoaEdit").scope().resetForm()},
600)};a.findPessoaEstruturaOrganizacionalResponsavel=function(b){return r.findColaboradorPorNomeAndOrganizacao(b,a.usuarioLogado.organizacao.id).then(function(b){return h("idNotEqualObj")(b,a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis,"responsavel")})};a.limparPessoaEstruturaOrganizacionalResponsavel=function(){delete a.pessoaEstruturaOrganizacionalResponsavel};a.addPessoaEFuncaoEstruturaOrganizacionalResponsavel=function(){if(a.pessoaEstruturaOrganizacionalResponsavel&&a.pessoaEstruturaOrganizacionalResponsavel.id){var b=
{responsavel:a.pessoaEstruturaOrganizacionalResponsavel};delete a.pessoaEstruturaOrganizacionalResponsavel;a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis.push(b)}else a.showAlert("error",c.instant("VALIDACAO.SELECIONAR_UM_RESPONSAVEL"))};a.addEstruturaOrganizacionalComPai=function(b){a.estruturaOrganizacionalForm.$submitted=!1;a.scrollToCadastro("#containerEstruturaOrganizacional");limparEstruturaOrganizacionalSelecionadas();b.$edit=!0;a.estruturaOrganizacional={estruturasOrganizacionalResponsaveis:[],
estruturaOrganizacionalParent:b};a.estruturaOrganizacional.idEstruturaOrganizacionalParent=b.id;l()};a.getEstruturaOrganizacional=function(b,d){a.setLoadingSalva(!0);g.get(b.id).then(function(b){a.estruturaOrganizacional=b.originalElement;null===a.estruturaOrganizacional.dataBloqueio||void 0===a.estruturaOrganizacional.dataBloqueio?(a.isBloquear=!0,a.isDesbloquear=!a.isBloquear,a.edit=d):(a.isBloquear=!1,a.isDesbloquear=!a.isBloquear,a.edit=!1);a.pgEdit=d;a.setLoading(!1)});if(a.patrimonioAtivo&&
b.id){var e=f.get(["EstruturaOrganizacionalPatrimonioRepository"]);e.getByEstruturaOrganizacional(b).then(function(b){a.estruturaOrganizacionalPatrimonio=b.originalElement})}a.almoxarifadoAtivo&&b.id&&(e=f.get(["EstruturaOrganizacionalAlmoxarifadoRepository"]),e.getByEstruturaOrganizacional(b).then(function(b){a.estruturaOrganizacionalAlmoxarifado=b.originalElement;l()}))};a.validaDataInicioMaiorDataFim=function(){if(a.estruturaOrganizacional.dataInicio&&a.estruturaOrganizacional.dataFim){var b=converterStringEmDate(h("date")(a.estruturaOrganizacional.dataInicio,
"dd/MM/yyyy")),d=converterStringEmDate(h("date")(a.estruturaOrganizacional.dataFim,"dd/MM/yyyy"));return b.getTime()>d.getTime()?!0:!1}};a.saveOrUpdate=function(){a.estruturaOrganizacionalForm.$submitted=!0;a.estruturaOrganizacionalForm.$valid?a.validaDataInicioMaiorDataFim()?a.showAlert("error",c.instant("VALIDACAO.CAMPO_DATA_INICIO_FIM")):(a.estruturaOrganizacional.dataFim||delete a.estruturaOrganizacional.dataFim,void 0===a.estruturaOrganizacional.id?k():void 0!==a.estruturaOrganizacional.dataFim&&
""!==a.estruturaOrganizacional.dataFim&&null!==a.estruturaOrganizacional.dataFim?s():k()):a.showAlert("error",c.instant("MSG.MN001"))};a.moveToUp=function(b,d){var e,c=a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis;a.estruturasOrganizacionalResponsaveisSelection=[];void 0!==c[d-1]&&(e=c[d-1],c[d-1]=c[d],c[d]=e)};a.moveToDown=function(b,d){var c,f=a.estruturaOrganizacional.estruturasOrganizacionalResponsaveis;a.estruturasOrganizacionalResponsaveisSelection=[];void 0!==f[d+1]&&(c=f[d+
1],f[d+1]=f[d],f[d]=c)};a.remove=function(b){g.contemEntidadeVinculada(b.id).then(function(d){d?a.showAlert("warning",c.instant("VALIDACAO.ERRO_EXCLUSAO_ESTRUTURA")):a.$openModalConfirm({message:b.almoxarifado?c.instant("MSG.REMOVER_ESTRUTURA_ALMOXARIFADO"):c.instant("MSG.MG004"),callback:function(){g.remove(b).then(function(){a.estruturaOrganizacional={};a.$modalConfirmInstance.dismiss("cancel");a.showAlert("success",c.instant("MSG.MG001"));angular.element("#searchEstruturaOrganizacional").scope().fetchResultEstrutura();
a.resetForm()})}})})};a.patrimonioAtivo=a.isModuloAtivo("/citgrp-patrimonio-web");a.abreModalPatrimonio=function(){a.editPatrimonio=a.edit;a.$openModal("modal-estruturaOrganizacionalPatrimonio.html","lg")};a.salvarEstruturaPatrimonio=function(b){b.$submitted=!0;b.$valid?(f.get(["EstruturaOrganizacionalPatrimonioRepository"]).save(a.estruturaOrganizacionalPatrimonio).then(function(b){a.estruturaOrganizacionalPatrimonio=b.originalElement}),a.$modalInstance.dismiss("cancel"),a.showAlert("success",c.instant("MSG.SUCESSO_ESTRUTURA_PATRIMONIO"))):
a.showAlert("error",c.instant("VALIDACAO.ALERTA_OBRIGATORIOS"))};a.resetEstruturaPatrimonio=function(){f.get(["EstruturaOrganizacionalPatrimonioRepository"]).getByEstruturaOrganizacional(a.estruturaOrganizacional).then(function(b){a.estruturaOrganizacionalPatrimonio=b.originalElement})};a.almoxarifadoAtivo=a.isModuloAtivo("/cit-almoxarifado-web");a.abreModalAlmoxarifado=function(){a.editAlmoxarifado=a.edit;a.$openModal("modal-estruturaOrganizacionalAlmoxarifado.html","lg")};a.salvarEstruturaAlmoxarifado=
function(b){b.$submitted=!0;b.$valid?(a.estruturaOrganizacionalAlmoxarifado.diasQueUnidadeConsumidoraPodeFazerRequisicao=t(),f.get(["EstruturaOrganizacionalAlmoxarifadoRepository"]).save(a.estruturaOrganizacionalAlmoxarifado).then(function(b){a.estruturaOrganizacionalAlmoxarifado=b.originalElement}),a.$modalInstance.dismiss("cancel"),a.showAlert("success",c.instant("MSG.SUCESSO_ESTRUTURA_ALMOXARIFADO"))):a.showAlert("error",c.instant("VALIDACAO.ALERTA_OBRIGATORIOS"))};a.resetEstruturaAlmoxarifado=
function(){f.get(["EstruturaOrganizacionalAlmoxarifadoRepository"]).getByEstruturaOrganizacional(a.estruturaOrganizacional).then(function(b){a.estruturaOrganizacionalAlmoxarifado=b.originalElement;l()})};a.setarDiaRequisicao=function(b){a.diasCompletos[b].value=!a.diasCompletos[b].value}}]);