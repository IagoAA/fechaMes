citApp.controller("DashboardController",["$scope","$translate","WidgetRepository","dashboard","PainelRepository","$timeout",function(b,l,m,n,f,p){b.dashboardEsi=!1;b.init=function(a){b.dashboardEsi=a};b.paineis=[];b.painelEdicao={};b.obterDadosPainel=function(a,c){a.montouPainelItens||f.get(a.id).then(function(a){a.montouPainelItens=!0;a.active=!0;b.paineis[c]=a;b.montarDashboard(b.paineis[c])})};b.saveOrUpdate=function(a){b.setLoadingSalva(!0);b.obterPainelPorId(a.idPainel);b.atualizarPainelItens(a);
f.salvarDashBoardUsuario(b.painelEdicao.originalElement).then(function(c){b.atualizarPainel(c,a.idPainel);b.painelEdicao=c;b.setLoading(!1);b.showAlert("success",l.instant("MSG.MG001"))})};b.obterPaineis=function(){f.findPorUsuario().then(function(a){b.dashboardEsi?(b.paineis=[],angular.forEach(a,function(a){angular.forEach(a.painelModulos,function(h){0<=h.modulo.nome.toUpperCase().indexOf("ESI")&&b.paineis.push(a.originalElement)})})):b.paineis=a;0<b.paineis.length&&(b.ordenarLista(b.paineis,"nome"),
f.findPainelDashBoard(b.paineis[0].id).then(function(a){a.montouPainelItens=!0;a.active=!0;b.paineis[0]=a;b.montarDashboard(b.paineis[0])}))})};b.montarDashboard=function(a){if(a.painelItens){b.ordenarLista(a.painelItens,"posicaoColumn");var c=[],h={},g=[],k=[],e={},d=0,f=200;angular.forEach(a.painelItens,function(a){var c={};c.title=a.nome;c.type=a.type;c.posicaoLinha=a.posicaoLinha;c.idPainelItem=a.id;c.widget=a.widget;c.remover=!1;c.config={path:a.urlServico,parametros:a.painelItemParametros,apresentarUrl:a.widget.apresentarUrlServico,
tempoServico:f,links:a.links,tempoAtualizacao:a.tempoAtualizacao};f+=200;a.posicaoColumn==d?(e.styleClass=a.styleClass,g.push(c)):(b.ordenarLista(g,"posicaoLinha"),e.widgets=g,k.push(e),g=[],e={},e.styleClass=a.styleClass,g.push(c),d++)});b.ordenarLista(g,"posicaoLinha");e.widgets=g;k.push(e);h.columns=k;c.push(h);a.model={};a.model.rows=c;a.model.idPainel=a.id}};b.atualizarPainelItens=function(a){angular.forEach(a.rows,function(a){angular.forEach(a.columns,function(a,c){var f=1;angular.forEach(a.widgets,
function(e){var d=b.obterPainelItemPorId(e.idPainelItem);d?(d.type=e.type,d.nome=e.title,d.posicaoColumn=c,d.posicaoLinha=f,f++,d.styleClass=a.styleClass,d.remover=e.remover,d.urlServico=e.config.path,d.painelItemParametros=e.config.parametros,d.links=e.config.links,d.tempoAtualizacao=e.config.tempoAtualizacao):e.remover||(d={},d.type=e.type,d.nome=e.title,d.posicaoColumn=c,d.posicaoLinha=f,d.styleClass=a.styleClass,d.urlServico=e.config.path,d.widget=e.widget,d.links=e.config.links,d.tempoAtualizacao=
e.config.tempoAtualizacao,f++,b.painelEdicao.originalElement.painelItens.push(d))})})})};b.obterPaineis();b.obterPainelItemPorId=function(a){var c=null;angular.forEach(b.painelEdicao.originalElement.painelItens,function(b){a&&b.id===a&&(c=b)});return c};b.obterPainelPorId=function(a){b.painelEdicao={};angular.forEach(b.paineis,function(c){a&&c.id===a&&angular.copy(c,b.painelEdicao)})};b.atualizarPainel=function(a,c){angular.forEach(b.paineis,function(f,g){f.id===c&&(b.paineis.splice(g,1),b.paineis.push(a),
a.active=!0,b.ordenarLista(b.paineis,"id"),b.montarDashboard(a))})};b.ordenarLista=function(a,b){a.sort(function(a,f){a=parseInt(a[b]);f=parseInt(f[b]);return a-f});return a};b.$on("adfDashboardChanged",function(a,c,f){b.saveOrUpdate(f)})}]);