citApp.controller("UsuarioController",["$scope","UsuarioRepository","PaginaUsuarioRepository","FiltroRepository","$translate","$timeout","FavoritoRepository","OrganizacaoRepository","UsuarioOrganizacaoItemRepository","$filter","PrivilegioRepository","GrupoRepository",function(a,f,h,l,d,g,r,m,n,k,p,q){a.usuario={contaHabilitada:!0,contaExpirada:!1,contaBloqueada:!1,credencialExpirada:!1,sempreNovaAba:!1,organizacoes:[],grupoUsuarios:[]};a.searchParams={};a.indexFiltro={};a.indexPagina={};a.novo=!1;
a.isBloquear=!1;a.isDesbloquear=!1;a.resetForm=function(){a.limparUsuario();a.edit=!0;a.novo=!0;a.pgEdit=!0;a.isBloquear=!1;a.isDesbloquear=a.isBloquear;a.searchParams={};a.indexFiltro={};a.indexPagina={};a.privilegiosSource=[];a.atualizarListaPrivilegios();delete a.isRedefinirSenha;a.findGrupoSource();g(function(){a.usuarioForm.$submitted=!1;a.usuarioForm.$setPristine()})};a.atualizarListaPrivilegios=function(){a.privilegiosSource=[];p.getList().then(function(b){for(var c={},e=0;e<b.length;e++)c=
{privilegio:b[e].originalElement},a.privilegiosSource.push(c);a.usuario&&a.usuario.usuarioPrivilegios&&a.usuario.usuarioPrivilegios.forEach(function(b,c){var e=_.findIndex(a.privilegiosSource,{privilegio:{id:b.privilegio.id}});0<=e&&(a.privilegiosSource[e]=b)})})};a.atualizarListaPrivilegios();a.findGrupoSource=function(){a.grupoUsuariosSource=[];q.getList().then(function(b){for(var c={},e=0;e<b.length;e++)c={grupo:b[e].originalElement},a.grupoUsuariosSource.push(c);a.usuario&&a.usuario.grupoUsuarios&&
a.usuario.grupoUsuarios.forEach(function(b,c){var e=_.findIndex(a.grupoUsuariosSource,{grupo:{id:b.grupo.id}});0<=e&&(a.grupoUsuariosSource[e]=b)})})};a.atualizaPaginaPesquisa=function(){angular.element("#searchUsuario").scope().fetchResult()};a.confirmarBloqueioUsuario=function(){a.usuario.dataBloqueio&&""!==a.usuario.dataBloqueio?f.save(a.usuario).then(function(b){a.usuario=b.originalElement;a.atualizarListaPrivilegios();a.findGrupoSource();a.isBloquear=!1;a.isDesbloquear=!a.isBloquear;a.edit=!1;
a.showAlert("success",d.instant("MSG.SUCESSO_BLOQUEIO"))}):a.showAlert("error",d.instant("MSG.MG011")," ",!1)};a.desbloquear=function(){a.setLoadingSalva(!0);a.usuario.dataBloqueio=null;f.save(a.usuario).then(function(b){a.setLoadingSalva(!1);a.usuario=b.originalElement;a.atualizarListaPrivilegios();a.findGrupoSource();a.edit=!0;a.isBloquear=!0;a.isDesbloquear=!a.isBloquear;a.showAlert("success",d.instant("MSG.SUCESSO_DESBLOQUEIO"))})};a.remove=function(b){a.usuario=b;a.$openModalConfirm({message:d.instant("MSG.CONFIRMA_EXCLUSAO"),
callback:function(){f.remove(a.usuario).then(function(){a.$modalConfirmInstance.dismiss("cancel");a.showAlert("success",d.instant("MSG.SUCESSO_USUARIO_EXCLUIDO"));angular.element("#searchUsuario").scope().fetchResult();a.resetForm()})}})};a.validaUsername=function(){if(void 0===a.usuario.id&&a.usuario.username)return f.buscaUsuarioByUsername(angular.lowercase(a.usuario.username)).then(function(b){b.originalElement.id&&(a.usuario.username="",a.showAlert("error",d.instant("MSG.NOME_USUARIO_EM_USO"),
" ",!1))})};a.validaEmail=function(){if(void 0===a.usuario.id&&a.usuario.email)return f.buscaUsuarioByEmail(a.usuario.email).then(function(b){b.originalElement.id&&(a.usuario.email="",a.showAlert("error",d.instant("MSG.EMAIL_USUARIO_EM_USO")," ",!1))})};a.removeCheckedSearchParams=function(a){a.searchParams.forEach(function(a){a.$checked=!1})};a.removeShowPaginaUsuario=function(){a.usuario.paginasUsuario.forEach(function(b){a.removeCheckedSearchParams(b);b.$show=!1})};a.showPaginaUsuario=function(b){a.indexFiltro=
null;a.indexPagina=null;!0!==b.$show&&a.removeShowPaginaUsuario();b.$show=!b.$show};a.removerFiltro=function(){null!==a.indexPagina&&null!==a.indexFiltro?a.$openModalConfirm({message:d.instant("LABEL.CONFIRMA_EXCLUSAO"),callback:function(){l.remove(a.searchParams).then(function(){});a.usuario.paginasUsuario[a.indexPagina].searchParams.splice(a.indexFiltro,1);a.$modalConfirmInstance.dismiss("cancel")}}):a.showAlert("warning",d.instant("MSG.SELECIONE_UM_ITEM_REMOVER_FILTRO"))};a.checkFiltroUsuario=
function(b,c,e){a.indexPagina=b;a.indexFiltro=c;a.searchParams=e};a.saveOrUpdate=function(){a.usuarioForm.$submitted=!0;a.usuarioForm.$valid&&a.usuario.organizacoes&&0<a.usuario.organizacoes.length?(a.setLoadingSalva(!0),angular.forEach(a.usuario.organizacoes,function(a){void 0!==a.$selected&&delete a.$selected}),f.save(a.usuario).then(function(b){a.usuario=b.originalElement;a.atualizarListaPrivilegios();a.findGrupoSource();a.isBloquear=!0;a.isDesbloquear=!a.isBloquear;a.showAlert("success",d.instant("MSG.SUCESSO_USUARIO"));
a.isRedefinirSenha=!1;a.novo=!1;a.usuarioLogado.id===a.usuario.id&&a.atualizarUsuarioLogado();g(function(){a.usuarioForm.$submitted=!1;a.usuarioForm.$setPristine();a.setLoading(!1)})})):(a.usuarioForm.$error.email?a.showAlert("error",d.instant("MSG.EMAIL_INVALIDO")," ",!1):a.showAlert("error",d.instant("VALIDACAO.ALERTA_OBRIGATORIOS")," ",!1),a.usuarioForm.$submitted=!1)};a.limparUsuario=function(){a.usuario={contaHabilitada:!0,contaExpirada:!1,contaBloqueada:!1,credencialExpirada:!1,sempreNovaAba:!1,
organizacoes:[],usuarioPrivilegios:[],organizacao:{},grupoUsuarios:[]}};a.verificaSenha=function(){a.usuario.password&&a.usuario.confirmPassword&&a.usuario.password!==a.usuario.confirmPassword&&(a.usuario.password="",a.usuario.confirmPassword="",a.showAlert("error",d.instant("VALIDACAO.SENHAS_DIFERENTES")," ",!1))};a.verificaNovaSenha=function(){a.usuario.novaSenha&&a.usuario.confirmNovoPassword&&a.usuario.novaSenha!==a.usuario.confirmNovoPassword&&(a.usuario.novaSenha="",a.usuario.confirmNovoPassword=
"",a.showAlert("error",d.instant("VALIDACAO.SENHAS_DIFERENTES")," ",!1))};void 0==a.$parent||a.$parent.newObejct&&0==a.$parent.idObejct||(a.setLoadingGet(!0),f.get(a.$parent.idObejct).then(function(b){a.usuario=b.originalElement;a.setLoading(!1)}));a.getUsuario=function(b,c){a.setLoadingGet(!0);f.get(b.id).then(function(b){a.usuario=b.originalElement;a.atualizarListaPrivilegios();a.findGrupoSource();!0===c&&(a.isRedefinirSenha=!1,a.novo=!1);void 0===a.usuario.dataBloqueio||null===a.usuario.dataBloqueio?
(a.isBloquear=!0,a.isDesbloquear=!a.isBloquear,a.edit=c):(a.isBloquear=!1,a.isDesbloquear=!a.isBloquear,a.edit=!1);a.pgEdit=c;g(function(){a.usuarioForm.$submitted=!1;a.usuarioForm.$setPristine();a.grupoUsuariosSource=k("idNotEqualGrupoUsuarioSourcePickList")(a.grupoUsuariosSource,a.usuario.grupoUsuarios)});a.setLoading(!1)})};a.adicionarOuRemoverFavoritoPaginaUsuario=function(a){void 0!==a.favorito&&null!==a.favorito?h.removeFavoritoPaginaUsuario(a.id).then(function(c){a.version=c.originalElement.version;
a.favorito=null}):h.favoritarPaginaUsuario(a.id).then(function(c){a.version=c.originalElement.version;a.favorito=c.originalElement.favorito})};a.editarUsuario=function(){a.edit=!0;a.pgEdit=!0;a.isRedefinirSenha=!1;g(function(){a.usuarioForm.$submitted=!1;a.usuarioForm.$setPristine()})};a.listarFavoritos=function(){a.resetForm();f.get(a.usuarioLogado.id).then(function(b){a.usuario=b.originalElement;a.isRedefinirSenha=!1;a.novo=!1;null===a.usuario.dataBloqueio||void 0===a.usuario.dataBloqueio?(a.isBloquear=
!0,a.isDesbloquear=!a.isBloquear,a.edit=!0):(a.isBloquear=!1,a.isDesbloquear=!a.isBloquear,a.edit=!1);a.pgEdit=!0;g(function(){a.usuarioForm.$submitted=!1;a.usuarioForm.$setPristine()});a.setLoading(!1)})};a.findOrganizacao=function(b){return m.listarOrganizacaoPorNome(b).then(function(b){return k("idNotEqualOrganizacao")(b,a.usuario.organizacoes)})};a.limparAutoCompleteOrganizacao=function(){g(function(){a.organizacao=null})};a.setOrganizacao=function(b){a.UsuarioOrganizacaoItem={organizacao:b};
a.usuario.organizacoes.push(a.UsuarioOrganizacaoItem);a.limparAutoCompleteOrganizacao()};a.checkAll=function(b){angular.forEach(a.usuario.organizacoes,function(a){a.$selected=b})};a.verificaSelectedAll=function(b){var c=!0;b.$selected?(angular.forEach(a.usuario.organizacoes,function(a){a.$selected||(c=!1)}),c&&(a.selectedAll=!0)):a.selectedAll=!1};a.montaListaDelete=function(){for(var b=!1,c=a.usuario.organizacoes.length-1;0<=c;c--)if(a.usuario.organizacoes[c].$selected){b=!0;break}b?a.$openModalConfirm({message:d.instant("MSG.DESEJA_EXCLUIR_ITENS"),
callback:function(){for(var b=a.usuario.organizacoes.length-1;0<=b;b--)a.usuario.organizacoes[b].$selected&&void 0!==a.usuario.organizacoes[b].id&&n.remove(a.usuario.organizacoes[b]).then(function(){a.usuario.organizacoes.splice(b,1);a.usuarioLogado.id===a.usuario.id&&a.atualizarUsuarioLogado()});g(function(){a.usuarioForm.$submitted=!1;a.usuarioForm.$setPristine()});a.selectedAll&&(a.selectedAll=!1);a.$modalConfirmInstance.dismiss("cancel");a.showAlert("success",d.instant("MSG.ORGANIZACOES_EXCLUIDAS"))}}):
a.showAlert("error",d.instant("MSG.SELECIONE_ITEM_EXCLUIR"))}}]);